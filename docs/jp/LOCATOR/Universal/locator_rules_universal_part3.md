# LOCATOR_RULES_UNIVERSAL_FULL_part3.md

## 6. `.first()` は最終手段である  
`.first()` は一見便利だが、E2E テストの安定性を大きく損なう “危険な道具” である。

### 6.1 `.first()` が危険な理由

#### **(1) 並び順依存になる**
UI 変更・A/B テスト・並べ替えなど、  
順番が変わる要因は多い。順序依存の Locator は壊れやすい。

#### **(2) 意図が不明確になる**
```
page.locator('button').first().click();
```
「なぜ最初のボタンなのか」「何を意図しているのか」がテストから消える。

#### **(3) 偶然を固定化してしまう**
E2E テストは “意図の再現” を目的とする。  
`.first()` はその意図を曖昧にしてしまう。

---

### 6.2 `.first()` を使っても良い状況（非常に限定される）

- UI の仕様上、一意の属性が存在しない  
- デザイン上、並び順が固定であることが保証されている  
- 「最初の要素」という概念が仕様として存在する（例：新着が常に先頭）

それでも以下を**必ず記述すること**：

```ts
// TODO: 一意の識別子が導入されたら置き換える
await page.locator('...').first().click();
```

---

## 7. 動的値は PageObject 層で扱う  
Locator に動的データ（例：ユーザー名、コース名）を直接埋め込むと、  
セレクタ定義が“変数の墓場”となり保守不能になる。

### 7.1 悪い例（NG）

```ts
export const SELECTORS = {
  USER_ROW: (name) => `tr:has-text("${name}")`,
};
```

- セレクタが動的になる  
- 他の静的セレクタと混ざり混乱する  
- テストの意図が読めない

---

### 7.2 良い例（OK）

```ts
// constants.ts には静的セレクタのみ
export const SELECTORS = {
  USER_ROW: 'tr',
};

// PageObject 側で動的値を補完
async clickUser(name: string) {
  await this.page.locator(`tr:has-text("${name}")`).click();
}
```

責務分離により：

- セレクタの “意味空間” が整理される  
- PageObject が “操作・条件・動的値” を管理できる  
- 変更時の影響範囲が明確になる  

---

## 8. セマンティック Locator（getByRole 等）を優先する思想

可能な限り以下を使う：

```
getByRole()
getByLabel()
getByPlaceholder()
getByText()
```

### 8.1 セマンティック Locator のメリット
- 意味に基づくため、UI が多少変わっても壊れない  
- テストコードが読みやすい  
- Accessibility の設計にも合致  
- AI が意図を正しく理解し、自然言語から生成しやすい  

### 8.2 ただし「HTML が未整備な現場」では使えない場合がある
例：role が設定されていない、label が不正など。

その場合でも **“使えない理由” が分かっていればよし**。  
セマンティック Locator は常に優先順位のトップに置く。

---

## 9. Locator の“抽象度”を適切に保つ

### 9.1 抽象度が低すぎる場合
```
div > div > span > button
```
→ 構造依存が強すぎる。

### 9.2 抽象度が高すぎる場合
```
button
```
→ ヒットしすぎて一意でなくなる。

### 9.3 正しい抽象度
```
button:text-is("保存")
```

抽象度とは「意味を損なわずに必要十分な特定ができるか」である。

---

## 10. Locator 設計における責務の分離

4 層アーキテクチャと密接に関係する：

- **第1層（Playwright API）**：技術の実体  
- **第2層（PageObject / Actions）**：Locator を具体的に実装する場所  
- **第3層（Concept）**：Locator の思想・禁止事項  
- **第4層（Test）**：Locator を直接触ってはならない層  

E2E 開発者は第3層の"思想"を理解し、第2層で実践する。

---

**最終更新**: 2026-02-02
**管理者**: Ray Ishida

